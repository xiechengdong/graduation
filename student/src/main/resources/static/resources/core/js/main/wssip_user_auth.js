/*!
 * 权限检查
 *
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{if(typeof module==="object"&&module.exports){module.exports=a(require("jquery"))}else{a(jQuery)}}}(function(c){var b={};var a={login:function(){console.log("登陆");var d=wssip.url.getUrl(site&&site.url&&site.url.login)||wssip.url.getPageUrl("/main/login.html");d=wssip.url.appUrlParam(d,{"winmode":"popup"});wdutil.win.open({type:"mini",uid:"relogin",data:{},url:d,title:"用户登陆",height:400,width:480,showMaxButton:false,showCloseButton:true,allowResize:false,showModal:true,ondestroy:function(f){var e=this.getIFrameEl();if(f=="close"){return true}else{return true}},onload:function(){var e=this.getIFrameEl()}});return},goLogin:function(){var d=wssip.url.getUrl(site&&site.url&&site.url.login)||wssip.url.getPageUrl("/main/login.html");setTimeout(function(){top.location=d},10)},hasAuthority:function(e,f){var d=this;if(typeof f==="function"){if(!this._isDataLoaded()){this._load(function(){f.call(d,d._authorizeHasAuthority(e))});return true}}return d._authorizeHasAuthority(e)},hasRole:function(f,e){var d=this;if(typeof e==="function"){if(!this._isDataLoaded()){this._load(function(){e.call(d,d._authorizeHasRole(f))});return true}}return d._authorizeHasRole(f)},checkAuth:function(){var d=this;return d._checkAuth()},_load:function(g,f){var e=this,d=(site&&site.url&&site.url.user);if(typeof g!=="function"){g=null;f=g}if(this._isDataLoaded()&&f!==true){g&&g.call(e);return}if(e.afterLoad===undefined){e.afterLoad=[]}g&&e.afterLoad.push(g);if(e.loading){return}e.loading=true;wdutil.request({type:"post",url:wssip.url.getUrl(d)||wssip.url.getDataUrl("/admin/auth/user"),dataType:"json",success:function(h){console.log("user load finished!");if(typeof h==="string"){h=wdutil.json.parse(h)}if(h&&h.data){h=h.data}e.data=h;e.loading=false;if(e.afterLoad&&e.afterLoad.length){while(e.afterLoad&&e.afterLoad.length){e.afterLoad.pop().call(e)}}else{e._checkAuth()}},error:function(h,j,i){delete e.data;e.loading=false;console.log("request error!",h,j,i)}})},_isDataLoaded:function(){return this.data!==undefined&&this.data!==null},_authorizeHasAuthority:function(h){var f=this;var e=/hasAuthority\((.*)\)/.exec(h);var g=e&&e[1];if(!g){g=h}if(this._isDataLoaded()&&this.data.authorities){for(var d=0;d<this.data.authorities.length;d++){if(this.data.authorities[d].authority===g){return true}}}return false},_authorizeHasRole:function(g){var d=/hasRole\((.*)\)/.exec(g);var f=d&&d[1];if(!f){f=g}if(this._isDataLoaded()&&this.data.roles){for(var e=0;e<this.data.roles.length;e++){if(this.data.roles[e].code===f){return true}}}return false},_checkAuth:function(){var d=this;if(!this._isDataLoaded()){this._load(function(){this._checkAuth()});return}c("[data-authorize]").not(":disabled").not(":hidden").each(function(){var e=c(this);var f=a._checkElement(e);if(!f){if(e.is("body")){d.goLogin()}else{e.hide()}}})},_checkElement:function(d){var e=d.attr("data-authorize");if(!e){return false}return a._orAuthorizes(e)},_orAuthorizes:function(e){var f=e.split(/\s+or\s+/);for(var d=0;d<f.length;d++){f[d]=c.trim(f[d].toString());if(f[d]!==""){if(a._andAuthorizes(f[d])){return true}}}return false},_andAuthorizes:function(f){var g=f.split(/\s+and\s+|\s*,\s*/);for(var d=0;d<g.length;d++){g[d]=c.trim(g[d].toString());if(g[d]){var e=false;if(g[d].indexOf("hasAuthority")==0){e=a._authorizeHasAuthority(g[d])}else{if(g[d].indexOf("hasRole")==0){e=a._authorizeHasRole(g[d])}else{e=a._authorizeHasAuthority(g[d])}}if(!e){return false}}}return true},_empty:null};c.extend(window["wssip"]||{},{"auth":a});c(function(){if(c("[data-authorize]").length){a._checkAuth()}});return c}));